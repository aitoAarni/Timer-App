name: E2E Tests with Maestro on Android

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    e2e-tests:
        runs-on: ubuntu-latest
        timeout-minutes: 30
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Set Up JDK (Required for Android SDK)
              uses: actions/setup-java@v3
              with:
                  distribution: 'temurin'
                  java-version: '17'

            - name: Set Up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 18

            - name: Install Dependencies
              working-directory: timerFront
              run: npm install

            - name: Install Expo CLI
              working-directory: timerFront
              run: npm install -g expo-cli

            - name: Install Maestro CLI
              run: |
                  curl -Ls "https://get.maestro.mobile.dev" | bash
                  echo "$HOME/.maestro/bin" >> $GITHUB_PATH

            - name: Cache Gradle Dependencies
              uses: actions/cache@v3
              with:
                  path: ~/.gradle/caches
                  key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/*.xml') }}
                  restore-keys: gradle-${{ runner.os }}

            - name: Set Up Android SDK
              uses: android-actions/setup-android@v3

            - name: Create & Start Android Emulator
              run: |
                  echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "system-images;android-30;google_apis;x86_64"
                  echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd -n testAVD -k "system-images;android-30;google_apis;x86_64" --device "pixel_4"
                  $ANDROID_HOME/emulator/emulator -avd testAVD -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect &
                  adb wait-for-device
                  adb shell input keyevent 82  # Unlock the emulator

            - name: Build and Start Expo Project
              working-directory: timerFront
              run: |
                  npx expo prebuild  # Generates native android files if needed
                  npx expo start --no-dev --minify &  # Start the Expo dev server in the background
                  sleep 20  # Give it time to start

            - name: Run Maestro E2E Tests
              working-directory: timerFront
              run: maestro test maestro/
